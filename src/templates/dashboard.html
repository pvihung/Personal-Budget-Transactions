<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        h1 { color: #333; margin-bottom: 10px; }
        .user-header { color: #666; margin-bottom: 20px; font-size: 14px; }
        .error { background-color: #ffe6e6; color: #a00; border: 1px solid #f5c2c2; padding: 12px; margin-bottom: 20px; border-radius: 4px; }
        .cards {
            display: flex;
            gap: 20px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }
        .card {
            border: 1px solid #ddd;
            padding: 15px 20px;
            border-radius: 6px;
            min-width: 140px;
            max_height: 80px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .card-title {
            font-size: 13px;
            color: #777;
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        .card-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        .section {
            background: white;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section-title {
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
        }
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 6px;
            min-width: 400px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .chart-container canvas {
            max-height: 300px;
        }
        .user-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .info-item {
            background: #f9f9f9;
            padding: 12px;
            border-radius: 4px;
            border-left: 4px solid #3498db;
        }
        .info-label {
            font-size: 12px;
            color: #777;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        .info-value {
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
        }
        .back-btn {
            display: inline-block;
            padding: 8px 15px;
            background-color: #3498db;
            color: white;
            text-decoration: none;
            width: auto;
            height: auto;
            align-self: auto;
        }
        .back-btn:hover {
            background-color: #2980b9;
        }
        .zone-box {
        padding: 6px 8px;
        border-radius: 4px;
        font-size: 18px;
        line-height: 1.3;
        margin-top: 4px;
        color: #2c3e50;
        }
    </style>
</head>
<body>
    <h1>Summary of Expense Dashboard</h1>
    {% if user %}
    <div class="user-header">Welcome, <strong>{{ user.user_name }}</strong></div>
    {% endif %}

    {% if error %}
    <div class="error"><strong>Error:</strong> {{ error }}</div>
    {% endif %}
    <!-- Filter Options (if any) can be added here -->
    <!-- Date Filter -->
    <form method="get" style="margin-bottom: 20px;">
    <label>Start Date:</label>
    <input type="date" name="start_date" value="{{ start_str }}">

    <label style="margin-left: 10px;">End Date:</label>
    <input type="date" name="end_date" value="{{ end_str }}">

    <label style="margin-left: 10px;">Category:</label>
    <select name="category">
        <!-- Empty = all categories -->
        <option value="" {% if not selected_category %}selected{% endif %}>All categories</option>
        {% for cat in pie_labels %}
            <option value="{{ cat }}"
                {% if selected_category == cat %}selected{% endif %}>
                {{ cat }}
            </option>
        {% endfor %}
    </select>

    <button type="submit"
            style="padding: 6px 12px; background-color: #3498db; color: white;
                   border: none; border-radius: 4px; margin-left: 10px;">
        Apply Filter
    </button>

    {% if start_str or end_str %}
    <a href="{{ url_for('dashboard', username=user.user_name) }}"
       style="padding: 6px 12px; background-color: #aaa; color: white;
              text-decoration: none; border-radius: 4px; margin-left: 10px;">
        Clear
    </a>
    {% endif %}

</form>
    <!-- User Overview Cards -->
    <div class="cards">
        <!-- Total Transaction !-->
        <div class="card">
            <div class="card-title">Total Transactions</div>
            <div class="card-value">{{ total_records }}</div>
        </div>
        <!-- Total Expense !-->
        <div class="card">
            <div class="card-title">Total Expenses</div>
            <div class="card-value">${{ total_expense | round(2) }}</div>
        </div>
        <!-- Total Income !-->
        <div class="card">
            <div class="card-title">Total Income</div>
            <div class="card-value">${{ total_income | round(2) }}</div>
        </div>
        <!-- Savings Rate !-->
        <!-- If learning rate is positive, show green; if negative, show red -->
        <div class="card">
            <div class="card-title">Saving Rate</div>
            <div class="card-value"
                style="color:
                    {% if saving_rate is not none and saving_rate > 0 %}
                        #27ae60
                    {% elif saving_rate is not none and saving_rate < 0 %}
                        #c0392b
                    {% else %}
                        #2c3e50
                    {% endif %};
                ">
                {% if saving_rate is not none %}
                    {{ (saving_rate * 100) | round(2) }}%
                {% else %}
                    N/A
                {% endif %}
            </div>
        </div>
        <!-- Velocity of Money !-->
        <div class="card">
            <div class="card-title">Velocity of Money</div>
            <div class="card-value"
                 style="color:
            {% if velocity > 0 %}
                #27ae60   /* green */
            {% elif velocity < 0 %}
                #c0392b   /* red */
            {% else %}
                #2c3e50   /* neutral */
            {% endif %};
            ">
            {{ velocity | round(2) }}
            </div>
        </div>

        <!-- In my pocket money !-->
        <div class="card">
            <div class="card-title">In My Pocket</div>

            {% if pocket_zone == "Safe Zone" %}
            <div class="zone-box"
                 style="
                    background: #e8f9e8;
                    border-left: 5px solid #27ae60;
                    padding: 15px;
                    border-radius: 6px;
                    color: #2c3e50;
                 ">
                <strong>Safe Zone:</strong> You are spending responsibly.<br>
                You have <strong>${{ in_my_pocket | round(2) }}</strong> available.<br>
                Recommended max spending: <strong>${{ recommended_safe_spend | round(2) }}</strong>.
            </div>

            {% elif pocket_zone == "Risk Zone" %}
            <div class="zone-box"
                 style="
                    background: #fff7cc;
                    border-left: 5px solid #e6a800;
                    padding: 15px;
                    border-radius: 6px;
                    color: #775f00;
                 ">
                <strong>Risk Zone:</strong> Your remaining funds are getting low.<br>
                Only <strong>${{ in_my_pocket | round(2) }}</strong> left.<br>
                Be cautious with spending.
            </div>

            {% else %}
            <div class="zone-box"
                 style="
                    background: #ffe6e6;
                    border-left: 5px solid #c0392b;
                    padding: 15px;
                    border-radius: 6px;
                    color: #a00000;
                 ">
                <strong>Warning Zone:</strong> Youâ€™ve exceeded your available income.<br>
                Try to stop spending more in this period.
            </div>
            {% endif %}
        </div>
    </div>


    <div class="section">
        <div class="section-title">Financial Overview</div>
        <div class="charts">
            <!-- Line Chart: Earning vs Spending by Month -->
            <div class="chart-container">
                <h2>Earning vs Spending by Month</h2>
                <canvas id="monthlyLine"></canvas>
            </div>
            <!-- Pie Chart: Spending by Category -->
            <div class="chart-container">
                <h2>Spending by Category</h2>
                <canvas id="spendingPie"></canvas>
            </div>
            <!-- Bar Chart: Monthly Net Cashflow -->
            <div class="chart-container">
                <h2>Monthly Net Cashflow</h2>
                <canvas id="netCashflowBar"></canvas>
            </div>
            <!-- Line Chart: Cumulative Income vs Expense -->
            <div class="chart-container">
                <h2>Cumulative Income vs Expense</h2>
                <canvas id="cumulativeCurve"></canvas>
            </div>
        </div>
    </div>
    <!-- Place holder for algorithm -->
    <script>
        const lineLabels = {{ line_labels | tojson }};
        const lineEarning = {{ point_income | tojson }};
        const lineSpending = {{ point_expense | tojson }};
        const pieLabels = {{ pie_labels | tojson }};
        const pieValues = {{ pie_values | tojson }};
        const netValues = {{ net_values | tojson }};
        const cumIncome    = {{ cum_income    | tojson }};
        const cumExpense   = {{ cum_expense   | tojson }};

        // Line chart: earning vs spending by month
        const ctxLine = document.getElementById("monthlyLine").getContext("2d");
        new Chart(ctxLine, {
            type: "line",
            data: {
                labels: lineLabels,
                datasets: [
                    {
                        label: "Earning",
                        data: lineEarning,
                        tension: 0.3,
                        fill: false,
                    },
                    {
                        label: "Spending",
                        data: lineSpending,
                        tension: 0.3,
                        fill: false,
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });

        // Pie chart: spending by category
        const ctxPie = document.getElementById("spendingPie").getContext("2d");
        new Chart(ctxPie, {
            type: "doughnut",
            data: {
                labels: pieLabels,
                datasets: [{
                    data: pieValues,
                    backgroundColor: [
                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                        '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
                    ],
                    borderColor: '#fff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: true, position: 'right' }
                }
            }
        });
        // Bar chart: Monthly Net Cashflow
        const ctxNet = document.getElementById("netCashflowBar").getContext("2d");
        new Chart(ctxNet, {
            type: "bar",
            data: {
                labels: lineLabels,   // same month labels
                datasets: [{
                    label: "Net Cashflow (Income - Expense)",
                    data: netValues,
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
        // Line chart: cumulative income vs expense
        const ctxCum = document.getElementById("cumulativeCurve").getContext("2d");
        new Chart(ctxCum, {
            type: "line",
            data: {
                labels: lineLabels,
                datasets: [{
                    label: "Cumulative Income",
                    data: cumIncome,
                    tension: 0.3,
                    fill: false,
                    },
                    {
                    label: "Cumulative Expense",
                    data: cumExpense,
                    tension: 0.3,
                    fill: false,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: { display: true, position: "bottom" }
                }
            }
        });
    </script>
    <! -- 10 Recent Transactions Table -->
    <div class="section">
    <div class="section-title">Recent Transactions</div>

    {% if recent_transactions %}
    <table style="width:100%; border-collapse: collapse; font-size:14px;">
        <thead>
            <tr style="background:#f2f2f2; text-align:left;">
                <th style="padding:8px; border-bottom:1px solid #ddd;">Date (Year/Month/Date)</th>
                <th style="padding:8px; border-bottom:1px solid #ddd;">Type (Income/Expense)</th>
                <th style="padding:8px; border-bottom:1px solid #ddd;">Category</th>
                <th style="padding:8px; border-bottom:1px solid #ddd;">Amount</th>
            </tr>
        </thead>
        <tbody>
            {% for t in recent_transactions %}
            <tr>
                <td style="padding:8px; border-bottom:1px solid #eee;">
                    {% if t.transaction_date is not none %}
                        {% if t.transaction_date.strftime is defined %}
                            {{ t.transaction_date.strftime('%Y/%m/%d') }}
                        {% else %}
                            {{ t.transaction_date }}
                        {% endif %}
                    {% endif %}
                </td>
                <td style="padding:8px; border-bottom:1px solid #eee;">{{ t.record_type }}</td>
                <td style="padding:8px; border-bottom:1px solid #eee;">{{ t.category}}</td>
                <td style="padding:8px; border-bottom:1px solid #eee;">${{ t.amount | round(2) }}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
        {% else %}
            <p style="color:#777;">No recent transactions in this period.</p>
        {% endif %}
    </div>
        <! -- Back to Profile Button -->
        <a href="{{ url_for('user_page', username=user.user_name) if user else '#' }}" class="back-btn">Back to Profile</a>
</body>
</html>
